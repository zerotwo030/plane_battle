<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜Ÿé™…æˆ˜æœº - ä¿®å¤å¢å¼ºç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        
        /* æ¸¸æˆç”»å¸ƒ */
        canvas { display: block; }

        /* UI ç•Œé¢å®¹å™¨ */
        #uiLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Arial', sans-serif; z-index: 10;
        }

        /* èœå•é¢æ¿ */
        .panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00d2ff;
            padding: 30px 50px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto;
            color: white;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
            display: none; /* JSæ§åˆ¶æ˜¾ç¤º */
        }

        h1 { font-size: 36px; margin-bottom: 10px; color: #00d2ff; text-shadow: 0 0 10px #00d2ff; }
        p { color: #ccc; margin-bottom: 25px; line-height: 1.5; }
        
        button {
            background: linear-gradient(45deg, #00d2ff, #007bff);
            border: none; padding: 12px 30px; color: white; font-size: 18px; border-radius: 25px;
            cursor: pointer; transition: 0.2s; outline: none;
        }
        button:hover { transform: scale(1.1); box-shadow: 0 0 15px #00d2ff; }

        /* å·¦ä¸Šè§’åˆ†æ•° */
        #hud {
            position: absolute; top: 20px; left: 20px;
            color: #ffcc00; font-size: 24px; font-weight: bold;
            font-family: monospace; pointer-events: none; z-index: 5;
        }
    </style>
</head>
<body>

    <div id="hud">SCORE: 0</div>
    <canvas id="gameCanvas"></canvas>

    <div id="uiLayer">
        <div id="startPanel" class="panel" style="display: block;">
            <h1>æ˜Ÿé™…æˆ˜æœº</h1>
            <p>æ“ä½œæ–¹å¼ï¼š<br>ğŸ’» é¼ æ ‡ç§»åŠ¨ æˆ– âŒ¨ï¸ WASD/æ–¹å‘é”®<br>ğŸ“± è§¦æ‘¸å±å¹•</p >
            <button onclick="initGame()">å¼€å§‹ä»»åŠ¡</button>
        </div>

        <div id="gameOverPanel" class="panel">
            <h1 style="color: #ff4444;">ä»»åŠ¡å¤±è´¥</h1>
            <p id="finalScore">å¾—åˆ†: 0</p >
            <button onclick="initGame()">é‡æ–°æŒ‘æˆ˜</button>
        </div>
    </div>

<script>
    /**
     * æ ¸å¿ƒä¿®å¤è¯´æ˜ï¼š
     * 1. ç¡®ä¿ width/height åœ¨ä½¿ç”¨å‰å·²èµ‹å€¼ã€‚
     * 2. å¢åŠ é”®ç›˜çŠ¶æ€ç›‘å¬ (keysPressed)ã€‚
     * 3. ä¿®å¤äº† inputX/Y åˆå§‹åŒ–ä¸º undefined/NaN å¯¼è‡´çš„ç»˜å›¾å¤±è´¥ã€‚
     */

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hud = document.getElementById('hud');
    const startPanel = document.getElementById('startPanel');
    const gameOverPanel = document.getElementById('gameOverPanel');

    // æ¸¸æˆå…¨å±€å˜é‡
    let width = window.innerWidth;
    let height = window.innerHeight;
    let isPlaying = false;
    let score = 0;
    let animationId;
    let frameCount = 0;

    // å®ä½“å®¹å™¨
    let player;
    let bullets = [];
    let enemies = [];
    let particles = [];
    let stars = [];

    // è¾“å…¥çŠ¶æ€
    let inputMode = 'mouse'; // 'mouse' or 'keyboard'
    let mouseX = width / 2;
    let mouseY = height - 100;
    const keysPressed = {}; // è®°å½•é”®ç›˜æŒ‰é”®

    // --- 1. åˆå§‹åŒ–ä¸å“åº”å¼ ---
    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        // å¦‚æœæ­£åœ¨ä½¿ç”¨é¼ æ ‡æ¨¡å¼ï¼Œé˜²æ­¢åæ ‡è¶…å‡ºè¾¹ç•Œ
        if(inputMode === 'mouse') {
            mouseX = Math.min(mouseX, width);
            mouseY = Math.min(mouseY, height);
        }
    }
    window.addEventListener('resize', resize);
    resize(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡

    // --- 2. è¾“å…¥ç›‘å¬ (ä¿®å¤å¹¶å¢å¼º) ---
    
    // é¼ æ ‡/è§¦æ‘¸ç›‘å¬
    window.addEventListener('mousemove', e => {
        if (!isPlaying) return;
        inputMode = 'mouse';
        mouseX = e.clientX;
        mouseY = e.clientY;
    });
    
    window.addEventListener('touchmove', e => {
        if (!isPlaying) return;
        e.preventDefault();
        inputMode = 'mouse';
        mouseX = e.touches[0].clientX;
        mouseY = e.touches[0].clientY;
    }, {passive: false});

    // é”®ç›˜ç›‘å¬
    window.addEventListener('keydown', e => {
        keysPressed[e.key] = true;
        if(isPlaying) inputMode = 'keyboard';
    });
    window.addEventListener('keyup', e => keysPressed[e.key] = false);

    // --- 3. æ¸¸æˆç±»å®šä¹‰ ---

    class Player {
        constructor() {
            this.width = 40;
            this.height = 50;
            this.x = width / 2;
            this.y = height - 100;
            this.speed = 8; // é”®ç›˜æ§åˆ¶æ—¶çš„ç§»åŠ¨é€Ÿåº¦
        }

        update() {
            // æ¨¡å¼ A: é¼ æ ‡/è§¦æ‘¸è·Ÿéš (å¹³æ»‘ç§»åŠ¨)
            if (inputMode === 'mouse') {
                // ä½¿ç”¨ç¼“åŠ¨ç®—æ³•è®©é£æœºè¿½é€é¼ æ ‡ä½ç½®
                const dx = mouseX - this.x;
                const dy = mouseY - this.y;
                this.x += dx * 0.15;
                this.y += dy * 0.15;
            } 
            // æ¨¡å¼ B: é”®ç›˜æ§åˆ¶
            else {
                if (keysPressed['w'] || keysPressed['ArrowUp']) this.y -= this.speed;
                if (keysPressed['s'] || keysPressed['ArrowDown']) this.y += this.speed;
                if (keysPressed['a'] || keysPressed['ArrowLeft']) this.x -= this.speed;
                if (keysPressed['d'] || keysPressed['ArrowRight']) this.x += this.speed;
            }

            // è¾¹ç•Œé™åˆ¶
            if (this.x < 20) this.x = 20;
            if (this.x > width - 20) this.x = width - 20;
            if (this.y < 20) this.y = 20;
            if (this.y > height - 20) this.y = height - 20;
        }

        draw() {
            ctx.fillStyle = '#00d2ff';
            ctx.beginPath();
            ctx.moveTo(this.x, this.y - this.height/2);
            ctx.lineTo(this.x - this.width/2, this.y + this.height/2);
            ctx.lineTo(this.x, this.y + this.height/4);
            ctx.lineTo(this.x + this.width/2, this.y + this.height/2);
            ctx.closePath();
            ctx.fill();
            
            // å–·å°„ç«ç„°æ•ˆæœ
            ctx.fillStyle = `rgba(255, ${Math.random()*155+100}, 0, 0.8)`;
            ctx.beginPath();
            ctx.moveTo(this.x - 5, this.y + this.height/4);
            ctx.lineTo(this.x + 5, this.y + this.height/4);
            ctx.lineTo(this.x, this.y + this.height/4 + Math.random() * 20 + 10);
            ctx.fill();
        }
    }

    class Bullet {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.width = 4;
            this.height = 12;
            this.dead = false;
        }
        update() {
            this.y -= 12; // å­å¼¹é€Ÿåº¦
            if (this.y < 0) this.dead = true;
        }
        draw() {
            ctx.fillStyle = '#ffcc00';
            ctx.fillRect(this.x - this.width/2, this.y, this.width, this.height);
        }
    }

    class Enemy {
        constructor() {
            this.size = Math.random() * 20 + 20;
            this.x = Math.random() * (width - this.size * 2) + this.size;
            this.y = -this.size;
            this.speed = Math.random() * 3 + 2 + (score / 1000); // éš¾åº¦éšåˆ†æ•°å¢åŠ 
            this.dead = false;
        }
        update() {
            this.y += this.speed;
            if (this.y > height + this.size) this.dead = true;
        }
        draw() {
            ctx.fillStyle = '#ff4444';
            ctx.beginPath();
            ctx.moveTo(this.x - this.size/2, this.y - this.size/2);
            ctx.lineTo(this.x + this.size/2, this.y - this.size/2);
            ctx.lineTo(this.x, this.y + this.size/2);
            ctx.fill();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.vx = (Math.random() - 0.5) * 8;
            this.vy = (Math.random() - 0.5) * 8;
            this.life = 1.0;
            this.color = color;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= 0.04;
        }
        draw() {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class Star {
        constructor() {
            this.reset();
            this.y = Math.random() * height; // åˆå§‹éšæœºåˆ†å¸ƒ
        }
        reset() {
            this.x = Math.random() * width;
            this.y = 0;
            this.size = Math.random() * 2 + 0.5;
            this.speed = Math.random() * 4 + 0.5;
        }
        update() {
            this.y += this.speed;
            if (this.y > height) this.reset();
        }
        draw() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fillRect(this.x, this.y, this.size, this.size);
        }
    }

    // --- 4. æ¸¸æˆæµç¨‹æ§åˆ¶ ---

    function initGame() {
        startPanel.style.display = 'none';
        gameOverPanel.style.display = 'none';
        
        // é‡ç½®æ•°æ®
        score = 0;
        hud.innerText = "SCORE: 0";
        frameCount = 0;
        
        // é‡ç½®å®ä½“
        bullets = [];
        enemies = [];
        particles = [];
        
        // é‡æ–°åˆå§‹åŒ–ç©å®¶ä½ç½®
        resize(); // ç¡®ä¿å®½é«˜æ­£ç¡®
        player = new Player();
        mouseX = width / 2; // é‡ç½®é¼ æ ‡ç›®æ ‡ä½ç½®ï¼Œé˜²æ­¢å¼€å±€é£æœºä¹±é£
        mouseY = height - 100;
        inputMode = 'mouse'; // é»˜è®¤å›é¼ æ ‡æ¨¡å¼

        if (!isPlaying) {
            isPlaying = true;
            animate();
        }
    }

    function gameOver() {
        isPlaying = false;
        document.getElementById('finalScore').innerText = `æœ€ç»ˆå¾—åˆ†: ${score}`;
        gameOverPanel.style.display = 'block';
    }

    // --- 5. ä¸»å¾ªç¯ ---

    function animate() {
        if (!isPlaying) return;

        // æ¸…ç©ºç”»å¸ƒ
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, width, height);

        // 1. ç»˜åˆ¶èƒŒæ™¯æ˜Ÿç©º
        stars.forEach(s => { s.update(); s.draw(); });

        // 2. ç©å®¶é€»è¾‘
        player.update();
        player.draw();

        // 3. å­å¼¹é€»è¾‘ (æ¯8å¸§å‘å°„)
        if (frameCount % 8 === 0) {
            bullets.push(new Bullet(player.x, player.y - 25));
        }
        bullets.forEach((b, i) => {
            b.update();
            b.draw();
            if (b.dead) bullets.splice(i, 1);
        });

        // 4. æ•Œäººç”Ÿæˆ
        let spawnRate = score > 2000 ? 30 : 50;
        if (frameCount % spawnRate === 0) {
            enemies.push(new Enemy());
        }

        // 5. æ•Œäººä¸ç¢°æ’é€»è¾‘
        enemies.forEach((e, i) => {
            e.update();
            e.draw();

            // æ’åˆ°ç©å®¶
            const distPlayer = Math.hypot(player.x - e.x, player.y - e.y);
            if (distPlayer < (player.width/2 + e.size/2 - 5)) {
                gameOver();
            }

            // è¢«å­å¼¹å‡»ä¸­
            bullets.forEach((b, j) => {
                const distBullet = Math.hypot(b.x - e.x, b.y - e.y);
                if (distBullet < e.size/2 + b.width) {
                    // å‡»æ€
                    e.dead = true;
                    b.dead = true;
                    score += 100;
                    hud.innerText = `SCORE: ${score}`;
                    // äº§ç”Ÿç²’å­
                    for(let k=0; k<5; k++) particles.push(new Particle(e.x, e.y, e.speed>5?'#ff0000':'#ff4444'));
                }
            });

            if (e.dead) enemies.splice(i, 1);
        });

        // 6. ç²’å­ç‰¹æ•ˆ
        particles.forEach((p, i) => {
            p.update();
            p.draw();
            if (p.life <= 0) particles.splice(i, 1);
        });

        frameCount++;
        animationId = requestAnimationFrame(animate);
    }

    // --- å¯åŠ¨é€»è¾‘ ---
    
    // åˆå§‹åŒ–èƒŒæ™¯æ˜Ÿæ˜Ÿï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰
    for(let i=0; i<80; i++) stars.push(new Star());
    
    // å¾…æœºåŠ¨ç”»ï¼ˆåœ¨æœªå¼€å§‹æ¸¸æˆæ—¶è¿è¡Œï¼‰
    function idleLoop() {
        if (isPlaying) return;
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, width, height);
        stars.forEach(s => { s.update(); s.draw(); });
        requestAnimationFrame(idleLoop);
    }
    idleLoop();

</script>
</body>
</html>